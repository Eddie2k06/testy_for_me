<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz de Preguntas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { color-scheme: light dark; }
    [data-theme="dark"] body { background-color: #0f1115; color: #e9ecef; }
    body { background-color: #f8f9fa; padding-top: 72px; }

    .navbar-blur { backdrop-filter: saturate(180%) blur(8px); background: rgba(248,249,250,.85); }
    [data-theme="dark"] .navbar-blur { background: rgba(23,26,33,.75); }

    .question-box { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
    [data-theme="dark"] .question-box { background: #171a21; box-shadow: none; }

    .response-item { margin-bottom: 10px; }
    .form-check-input { transform: scale(1.1); margin-top: .55em; }
    .form-check-label { display: block; padding: 8px 12px; border-radius: .5rem; }
    .form-check-input:checked + .form-check-label { background: rgba(13,110,253,.08); }
    [data-theme="dark"] .form-check-input:checked + .form-check-label { background: rgba(13,110,253,.15); }

    .feedback { margin-left: 10px; font-weight: bold; }
    .counter { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: .9rem; color: #6c757d; }
    [data-theme="dark"] .counter { color: #adb5bd; }
    .progress { height: 8px; }

    /* Botones centrados √∫nicamente */
    .btn-group-bottom { display: flex; justify-content: center; gap: 12px; margin-top: 20px; }

    @media (max-width: 576px) {
      .question-box { padding: 16px; }
      .btn-group-bottom { flex-direction: column; }
      .btn-group-bottom .btn { width: 100%; }
      .navbar-brand { font-size: 1rem; }
      .form-check-input { transform: scale(1.2); }
      .form-check-label { padding: 10px 14px; }
    }

    /* Mejor espaciado de la navbar en m√≥viles */
    @media (max-width: 991.98px) {
      .navbar-nav .nav-item {
        width: 100%;
        margin-right: 0 !important;
        margin-bottom: .5rem;
      }
      .navbar-nav .btn,
      .navbar-nav .form-select {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light navbar-blur fixed-top border-bottom">
    <div class="container-fluid">
      <a class="navbar-brand fw-semibold" href="#"><span class="me-2">üß†</span>EddieSoft Quiz</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0 align-items-lg-center">
          <li class="nav-item my-1 me-lg-2">
            <button class="btn btn-sm btn-outline-secondary" id="btnCargarCarpeta">Cargar carpeta</button>
          </li>
          <li class="nav-item my-1 me-lg-3">
            <button class="btn btn-sm btn-outline-secondary" id="btnCargar">Cargar JSON</button>
          </li>
          <li class="nav-item my-1 me-lg-3">
            <label for="selectArchivo" class="form-label small d-block d-lg-inline mb-1 mb-lg-0">Archivo</label>
            <select id="selectArchivo" class="form-select form-select-sm" disabled>
              <option value="" selected disabled>Seleccion√° un JSON</option>
            </select>
          </li>
          <li class="nav-item dropdown my-1 me-lg-2">
            <a class="nav-link dropdown-toggle" href="#" id="dropdownPreguntas" data-bs-toggle="dropdown">Preguntas</a>
            <ul class="dropdown-menu" id="menuPreguntas">
              <li><a class="dropdown-item" href="#" data-limit="10">10</a></li>
              <li><a class="dropdown-item" href="#" data-limit="20">20</a></li>
              <li><a class="dropdown-item" href="#" data-limit="50">50</a></li>
              <li><a class="dropdown-item" href="#" data-limit="100">100</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item active" href="#" data-limit="all">Todas</a></li>
            </ul>
          </li>
        </ul>

        <div class="d-flex align-items-center gap-3">
          <button class="btn btn-sm btn-outline-secondary" id="btnExportar" disabled>Exportar CSV</button>
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalAcerca">Acerca de</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container mt-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="counter" id="contador">Pregunta: 0 de 0</div>
      <div class="flex-grow-1 ms-3">
        <div class="progress"><div class="progress-bar" id="barraProgreso" style="width: 0%"></div></div>
      </div>
    </div>

    <!-- Cuadro de preguntas -->
    <div id="contenido" class="question-box">
      <div>
        <p>Carg√° un archivo o carpeta con JSON para comenzar.</p>
      </div>
    </div>

    <!-- Botones centrados -->
    <div class="btn-group-bottom">
      <button class="btn btn-primary" id="btnEvaluar" disabled>Evaluar</button>
      <button class="btn btn-success" id="btnSiguiente" disabled>Siguiente</button>
    </div>

    <!-- Secci√≥n de revisi√≥n -->
    <div id="seccionRevision" class="mt-3 d-none"></div>
  </div>

  <!-- Modal Acerca de -->
  <div class="modal fade" id="modalAcerca" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Acerca de</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center">
          <p class="mb-1"><strong>EddieSoft</strong></p>
          <p class="mb-1">Quiz de Preguntas</p>
          <p class="mb-0">¬© <span id="anioAcerca">2025</span>. Todos los derechos reservados.</p>
        </div>
        <div class="modal-footer justify-content-center">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let preguntasCompletas=[], preguntas=[], indicePregunta=0, preguntasCorrectas=0, resultados=[];
    let limiteSeleccionado='all', inicioPreguntaMs=0;
    const archivosJSON=new Map();

    const contenido=document.getElementById('contenido'), contador=document.getElementById('contador');
    const barraProgreso=document.getElementById('barraProgreso');
    const btnEvaluar=document.getElementById('btnEvaluar'), btnSiguiente=document.getElementById('btnSiguiente');
    const btnCargar=document.getElementById('btnCargar'), btnCargarCarpeta=document.getElementById('btnCargarCarpeta');
    const selectArchivo=document.getElementById('selectArchivo');
    const btnExportar=document.getElementById('btnExportar');
    const seccionRevision=document.getElementById('seccionRevision');

    document.getElementById('anioAcerca').textContent=new Date().getFullYear();

    btnEvaluar.addEventListener('click', evaluarRespuesta);
    btnSiguiente.addEventListener('click', ()=>{indicePregunta++;mostrarPregunta();});
    btnExportar.addEventListener('click', exportarCSV);

    btnCargar.addEventListener('click', ()=>{
      const i=document.createElement('input');
      i.type='file'; i.accept='.json,application/json';
      i.onchange=e=>cargarArchivo(e.target.files[0]);
      i.click();
    });

    btnCargarCarpeta.addEventListener('click', ()=>{
      const i=document.createElement('input');
      i.type='file'; i.webkitdirectory=true; i.multiple=true;
      i.onchange=e=>cargarCarpeta(e.target.files);
      i.click();
    });

    selectArchivo.addEventListener('change', cargarDesdeSelector);

    document.querySelectorAll('#menuPreguntas a').forEach(a=>a.addEventListener('click',e=>{
      e.preventDefault();
      document.querySelectorAll('#menuPreguntas a').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
      limiteSeleccionado=a.dataset.limit==='all'?'all':parseInt(a.dataset.limit);
      if(preguntasCompletas.length) iniciarQuiz();
    }));

    function shuffleInPlace(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
    }

    function cargarArchivo(file){
      if(!file)return;
      file.text().then(txt=>{
        archivosJSON.set(file.name, txt);
        refrescarSelector();
        selectArchivo.value=file.name;
        cargarDesdeSelector();
      }).catch(e=>alert('Error: '+e.message));
    }

    function cargarCarpeta(files){
      archivosJSON.clear();
      const lista=[...files].filter(f=>f.name.toLowerCase().endsWith('.json'));
      if(!lista.length){ alert('No se encontraron .json en la carpeta.'); return; }
      Promise.all(lista.map(f=>f.text().then(t=>archivosJSON.set(f.name,t))))
        .then(()=>{
          refrescarSelector();
          contenido.innerHTML = `
            <div>
              <h5 class="mb-2">Seleccion√° un archivo en el navbar</h5>
              <p class="text-muted">Se detectaron ${lista.length} JSON.</p>
            </div>`;
        })
        .catch(e=>alert('No se pudo leer la carpeta:\n'+e.message));
    }

    function refrescarSelector(){
      selectArchivo.disabled = archivosJSON.size===0;
      selectArchivo.innerHTML='<option value="" disabled selected>Seleccion√° un JSON</option>';
      [...archivosJSON.keys()].sort().forEach(n=>{
        const o=document.createElement('option');o.value=n;o.textContent=n;selectArchivo.appendChild(o);
      });
    }

    function cargarDesdeSelector(){
      const nombre=selectArchivo.value;
      const txt=archivosJSON.get(nombre);
      if(!txt) return;
      try{
        let data = JSON.parse(txt);
        if(Array.isArray(data) && data.length===1 && Array.isArray(data[0])) data = data[0];
        validarEstructura(data);
        procesarPreguntas(data);
        iniciarQuiz();
        btnEvaluar.disabled=false;
      }catch(e){
        contenido.innerHTML = `<div class="alert alert-danger"><strong>Error JSON:</strong> ${e.message}</div>`;
      }
    }

    function validarEstructura(data){
      if(!Array.isArray(data) || !data.length) throw new Error('El JSON debe ser un array no vac√≠o de preguntas.');
      const ok = data.every(p => p && typeof p==='object' && p.pregunta && (p.rta_1||p.rta_2||p.rta_3));
      if(!ok) throw new Error('Cada √≠tem debe tener "pregunta" y al menos una "rta_1/2/3".');
    }
    function procesarPreguntas(data){
      const seen=new Set();
      preguntasCompletas=data.filter(p=>{
        const t=String(p.pregunta).trim();
        if(seen.has(t)) return false;
        seen.add(t); return true;
      });
    }

    function iniciarQuiz(){
      preguntasCorrectas=0; resultados=[];
      seccionRevision.classList.add('d-none');
      seccionRevision.innerHTML = '';

      if(limiteSeleccionado==='all' || limiteSeleccionado>=preguntasCompletas.length){
        preguntas=[...preguntasCompletas];
      }else{
        preguntas=preguntasCompletas.slice(0, limiteSeleccionado);
      }
      shuffleInPlace(preguntas);

      indicePregunta=0; mostrarPregunta();
      btnExportar.disabled=true;
    }

    function actualizarProgreso(){
      const total=preguntas.length||0;
      const pct=total? Math.round((indicePregunta/total)*100) : 0;
      barraProgreso.style.width=pct+'%';
    }

    function normalizarRespuestas(p){
      const keys=['rta_1','rta_2','rta_3'].filter(k=>p[k]);
      const arr = keys.map(k=>({texto:p[k].texto, correcta:String(p[k].rta).toLowerCase()==='yes'}));
      while(arr.length<3) arr.push({texto:'Opci√≥n faltante', correcta:false});
      return arr;
    }

    function tipoInputs(respuestas){
      const c = respuestas.filter(r=>r.correcta).length;
      return c===1 ? 'radio' : 'checkbox';
    }

    function mostrarPregunta(){
      if(indicePregunta>=preguntas.length){ fin(); return; }
      const p=preguntas[indicePregunta];
      contador.textContent=`Pregunta: ${indicePregunta+1} de ${preguntas.length}`;
      actualizarProgreso();

      let respuestas=normalizarRespuestas(p);
      shuffleInPlace(respuestas);

      const inputType=tipoInputs(respuestas);

      let html=`<h5 class="mb-3">${p.pregunta}</h5>`;
      respuestas.forEach((r,i)=>{
        html+=`
          <div class="response-item">
            <div class="form-check">
              <input class="form-check-input" type="${inputType}" name="grupo" id="r${i}">
              <label class="form-check-label" for="r${i}">
                ${r.texto} <span id="f${i}" class="feedback"></span>
              </label>
            </div>
          </div>`;
      });
      contenido.innerHTML=html;

      btnEvaluar.disabled=false;
      btnSiguiente.disabled=true;

      contenido.dataset.respuestas=JSON.stringify(respuestas);
      contenido.dataset.pregunta=JSON.stringify(p);
      inicioPreguntaMs=performance.now();
    }

    function indicesDe(arr, val){
      return arr.map((v,i)=>v===val?i:-1).filter(i=>i!==-1);
    }

    function evaluarRespuesta(){
      const respuestas=JSON.parse(contenido.dataset.respuestas);
      const inputs=[...contenido.querySelectorAll('input.form-check-input')];
      const seleccionadas=inputs.map(i=>i.checked);

      respuestas.forEach((r,i)=>{
        const f=document.getElementById('f'+i);
        f.textContent=r.correcta?'‚úÖ':'‚ùå';
        f.style.color=r.correcta?'green':'red';
        inputs[i].disabled=true;
      });

      const acierto = respuestas.every((r,i)=>r.correcta===seleccionadas[i]);
      if(acierto) preguntasCorrectas++;

      btnEvaluar.disabled=true;
      btnSiguiente.disabled=false;

      const p=JSON.parse(contenido.dataset.pregunta);
      const tiempo=(performance.now()-inicioPreguntaMs)/1000;

      resultados.push({
        i: indicePregunta+1,
        pregunta: p.pregunta,
        respuestasRender: respuestas,
        marcadas: indicesDe(seleccionadas, true),
        correctas: indicesDe(respuestas.map(r=>r.correcta), true),
        acierto,
        tiempo
      });
    }

    function fin(){
      contenido.innerHTML=`
        <h4 class="text-center">¬°Quiz finalizado!</h4>
        <p class="text-center fs-5">Puntaje: ${Math.round((preguntasCorrectas/preguntas.length)*100)}/100</p>
        <div class="d-flex justify-content-center mt-3">
          <button class="btn btn-outline-secondary" id="btnToggleRevision">Ver revisi√≥n</button>
        </div>
      `;
      btnEvaluar.disabled=true;
      btnSiguiente.disabled=true;
      btnExportar.disabled=false;
      barraProgreso.style.width='100%';

      seccionRevision.innerHTML = renderRevision();
      seccionRevision.classList.add('d-none');

      document.getElementById('btnToggleRevision').addEventListener('click', ()=>{
        seccionRevision.classList.toggle('d-none');
        const btn = document.getElementById('btnToggleRevision');
        btn.textContent = seccionRevision.classList.contains('d-none') ? 'Ver revisi√≥n' : 'Ocultar revisi√≥n';
      });
    }

    // <-- Corregida y completa
    function renderRevision(){
      if(!resultados.length) return '';
      return resultados.map((r) => {
        const filas = r.respuestasRender.map((res, i) => {
          const esCorrecta = res.correcta;
          const laMarque = r.marcadas.includes(i);
          const icon = esCorrecta ? '‚úÖ' : (laMarque ? '‚ùå' : '');
          return `<li>${icon} ${res.texto}</li>`;
        }).join('');
        return `
          <div class="card mb-2">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <strong>${r.i}. ${r.pregunta}</strong>
                <span class="text-muted small">${r.tiempo.toFixed(1)}s</span>
              </div>
              <ul class="mt-2 mb-0">${filas}</ul>
            </div>
          </div>
        `;
      }).join('');
    }

    function exportarCSV(){
      if(!resultados.length){ alert('No hay resultados'); return; }
      const csv=['nro,pregunta,tiempo'].concat(
        resultados.map(r=>`${r.i},"${String(r.pregunta||'').replace(/"/g,'""')}",${r.tiempo.toFixed(1)}`)
      ).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='resultados.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
